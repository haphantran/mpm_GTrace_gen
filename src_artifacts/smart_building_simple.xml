<?xml version="1.0" encoding="utf-8"?>
<mpm_trace:Canvas xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:mpm_trace="domain://MPM_trace">

  <!-- ========== METAMODELS ========== -->
  <nodes xmi:type="mpm_trace:MetaModel" name="Ecore"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="ATL"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="LTrace" conformsTo="//@nodes.0"/>

  <!-- Domain metamodels -->
  <nodes xmi:type="mpm_trace:MetaModel" name="RequirementsMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="ArchitectureMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PlatformIndependentMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PlatformSpecificMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="CodeMM" conformsTo="//@nodes.0"/>

  <!-- ========== VIEWPOINTS ========== -->
  <nodes xmi:type="mpm_trace:Viewpoint" name="Energy Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Security Viewpoint"/>

  <!-- ========== ROLES ========== -->
  <nodes xmi:type="mpm_trace:IoT_Engineer" name="IoT Engineer"/>
  <nodes xmi:type="mpm_trace:Embedded_System_Engineer" name="Embedded Engineer"/>

  <!-- ========== LEVEL 1: Requirements → Architecture ========== -->

  <!-- L1 Input Model -->
  <nodes xmi:type="mpm_trace:Model" name="SmartHomeRequirements"
         conformsTo="//@nodes.3"
         In="//@nodes.16"
         associatedWith="//@nodes.11"/>

  <!-- L1 Transformation (2 executions: baseline and optimized versions) -->
  <nodes xmi:type="mpm_trace:Transformation" name="Requirements2Architecture"
         exec="//@nodes.17 //@nodes.18"
         Out="//@nodes.19 //@nodes.20"
         conformsTo="//@nodes.1"/>

  <!-- L1 Execution V1 (baseline) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Req2Arch_v1"
         generates="//@nodes.21"/>

  <!-- L1 Execution V2 (energy optimized) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Req2Arch_v2_EnergyOpt"
         generates="//@nodes.22"/>

  <!-- L1 Output Model V1 (baseline architecture) -->
  <nodes xmi:type="mpm_trace:Model" name="SmartHomeArchitecture_v1"
         conformsTo="//@nodes.4"
         In="//@nodes.23"
         associatedWith="//@nodes.11"/>

  <!-- L1 Output Model V2 (energy optimized architecture) -->
  <nodes xmi:type="mpm_trace:Model" name="SmartHomeArchitecture_v2_EnergyOpt"
         conformsTo="//@nodes.4"
         In="//@nodes.29"
         representedAs="//@nodes.8"
         associatedWith="//@nodes.11"/>

  <!-- L1 Trace V1 (baseline) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Req2Arch_v1" conformsTo="//@nodes.2">
    <contains name="DecomposeTemperatureControl">
      <intents name="FunctionalDecomposition">
        <params name="strategy = component_based"/>
      </intents>
      <traceLinks name="TempControlReq -> TempSensor"/>
      <traceLinks name="TempControlReq -> Heater"/>
    </contains>
  </nodes>

  <!-- L1 Trace V2 (energy optimized) - has ancestor link to V1 -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Req2Arch_v2_EnergyOpt"
         conformsTo="//@nodes.2"
         ancestor="//@nodes.21">
    <contains name="DecomposeTemperatureControl">
      <intents name="EnergyAwareDecomposition">
        <params name="strategy = low_power"/>
        <params name="target_reduction = 30%"/>
      </intents>
      <traceLinks name="TempControlReq -> LowPowerTempSensor"/>
      <traceLinks name="TempControlReq -> SmartHeater"/>
      <traceLinks name="TempControlReq -> SleepScheduler"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 2: Architecture → Platform-Independent Model ========== -->

  <!-- L2 Transformation (from baseline architecture) -->
  <nodes xmi:type="mpm_trace:Transformation" name="Architecture2PIM"
         exec="//@nodes.24 //@nodes.25"
         Out="//@nodes.26 //@nodes.27"
         conformsTo="//@nodes.1"/>

  <!-- L2 Execution V1 (PID control) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Arch2PIM_v1_PID"
         generates="//@nodes.28"/>

  <!-- L2 Execution V2 (adaptive control) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Arch2PIM_v2_Adaptive"
         generates="//@nodes.30"/>

  <!-- L2 Output Model V1 (PID control) -->
  <nodes xmi:type="mpm_trace:Model" name="TempControlPIM_v1_PID"
         conformsTo="//@nodes.5"
         In="//@nodes.31"
         associatedWith="//@nodes.11"/>

  <!-- L2 Output Model V2 (adaptive control) -->
  <nodes xmi:type="mpm_trace:Model" name="TempControlPIM_v2_Adaptive"
         conformsTo="//@nodes.5"
         In="//@nodes.37"
         associatedWith="//@nodes.11"/>

  <!-- L2 Trace V1 (PID control) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Arch2PIM_v1_PID" conformsTo="//@nodes.2">
    <contains name="SpecifyControlAlgorithm">
      <intents name="AlgorithmSelection">
        <params name="algorithm = PID"/>
      </intents>
      <traceLinks name="TempSensor -> TemperatureInput"/>
      <traceLinks name="Heater -> PIDController"/>
    </contains>
  </nodes>

  <!-- L2 Transformation (from energy optimized architecture) -->
  <nodes xmi:type="mpm_trace:Transformation" name="EnergyArch2PIM"
         exec="//@nodes.32"
         Out="//@nodes.33"
         conformsTo="//@nodes.1"/>

  <!-- L2 Trace V2 (adaptive control) - has ancestor link to V1 -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Arch2PIM_v2_Adaptive"
         conformsTo="//@nodes.2"
         ancestor="//@nodes.28">
    <contains name="SpecifyControlAlgorithm">
      <intents name="AdaptiveAlgorithmSelection">
        <params name="algorithm = Adaptive_Threshold"/>
        <params name="power_mode = dynamic"/>
      </intents>
      <traceLinks name="LowPowerTempSensor -> TemperatureInput"/>
      <traceLinks name="SmartHeater -> AdaptiveController"/>
      <traceLinks name="SleepScheduler -> PowerManager"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 3: PIM → Platform-Specific Model ========== -->

  <!-- L3 Transformation (multiple platforms) -->
  <nodes xmi:type="mpm_trace:Transformation" name="PIM2PSM"
         exec="//@nodes.34 //@nodes.35"
         Out="//@nodes.36 //@nodes.38"
         conformsTo="//@nodes.1"/>

  <!-- L3 Execution (energy optimized path) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_EnergyArch2PIM"
         generates="//@nodes.39"/>

  <!-- L3 Output (energy optimized PIM) -->
  <nodes xmi:type="mpm_trace:Model" name="TempControlPIM_EnergyOpt"
         conformsTo="//@nodes.5"
         In="//@nodes.40"
         representedAs="//@nodes.8"
         associatedWith="//@nodes.11"/>

  <!-- L3 Execution V1 (ESP32) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2PSM_ESP32"
         generates="//@nodes.41"/>

  <!-- L3 Execution V2 (Arduino) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2PSM_Arduino"
         generates="//@nodes.42"/>

  <!-- L3 Output V1 (ESP32) -->
  <nodes xmi:type="mpm_trace:Model" name="TempControlPSM_ESP32"
         conformsTo="//@nodes.6"
         In="//@nodes.43"
         associatedWith="//@nodes.12"/>

  <!-- L3 Transformation (energy optimized PIM to PSM) -->
  <nodes xmi:type="mpm_trace:Transformation" name="EnergyPIM2PSM"
         exec="//@nodes.46"
         Out="//@nodes.47"
         conformsTo="//@nodes.1"/>

  <!-- L3 Output V2 (Arduino) -->
  <nodes xmi:type="mpm_trace:Model" name="TempControlPSM_Arduino"
         conformsTo="//@nodes.6"
         associatedWith="//@nodes.12"/>

  <!-- L3 Trace (energy optimized) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_EnergyArch2PIM"
         conformsTo="//@nodes.2"
         ancestor="//@nodes.22">
    <contains name="OptimizeForLowPower">
      <intents name="PowerOptimization">
        <params name="sleep_mode = enabled"/>
      </intents>
      <traceLinks name="SmartHeater -> DutyCycleControl"/>
      <traceLinks name="SleepScheduler -> DeepSleepManager"/>
    </contains>
  </nodes>

  <!-- L3 Transformation (energy optimized PIM to low power PSM) -->
  <nodes xmi:type="mpm_trace:Transformation" name="EnergyOptPIM2PSM"
         exec="//@nodes.48"
         Out="//@nodes.49"
         conformsTo="//@nodes.1"/>

  <!-- L3 Trace V1 (ESP32) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2PSM_ESP32" conformsTo="//@nodes.2">
    <contains name="MapToESP32">
      <intents name="PlatformMapping">
        <params name="platform = ESP32"/>
        <params name="frequency = 240MHz"/>
      </intents>
      <traceLinks name="PIDController -> ESP32_Task"/>
      <traceLinks name="TemperatureInput -> ADC_Pin"/>
    </contains>
  </nodes>

  <!-- L3 Trace V2 (Arduino) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2PSM_Arduino" conformsTo="//@nodes.2">
    <contains name="MapToArduino">
      <intents name="PlatformMapping">
        <params name="platform = Arduino_Uno"/>
        <params name="frequency = 16MHz"/>
      </intents>
      <traceLinks name="PIDController -> Arduino_Loop"/>
      <traceLinks name="TemperatureInput -> AnalogPin_A0"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 4: PSM → Code ========== -->

  <!-- L4 Transformation (ESP32 code generation) -->
  <nodes xmi:type="mpm_trace:Transformation" name="PSM2Code_ESP32"
         exec="//@nodes.44"
         Out="//@nodes.45"
         conformsTo="//@nodes.1"/>

  <!-- L4 Execution (ESP32 code) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PSM2Code_ESP32"
         generates="//@nodes.50"/>

  <!-- L4 Output (ESP32 firmware) -->
  <nodes xmi:type="mpm_trace:Model" name="ESP32_Firmware"
         conformsTo="//@nodes.7"
         associatedWith="//@nodes.12"/>

  <!-- L4 Execution (energy optimized PSM to code) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_EnergyPIM2PSM"
         generates="//@nodes.51"/>

  <!-- L4 Output (low power PSM) -->
  <nodes xmi:type="mpm_trace:Model" name="TempControlPSM_LowPower"
         conformsTo="//@nodes.6"
         representedAs="//@nodes.8"
         associatedWith="//@nodes.12"/>

  <!-- L4 Execution (low power code generation) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_EnergyOptPIM2PSM"
         generates="//@nodes.52"/>

  <!-- L4 Output (low power firmware) -->
  <nodes xmi:type="mpm_trace:Model" name="LowPowerFirmware"
         conformsTo="//@nodes.7"
         representedAs="//@nodes.8"
         associatedWith="//@nodes.12"/>

  <!-- L4 Trace (ESP32 code generation) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PSM2Code_ESP32" conformsTo="//@nodes.2">
    <contains name="GenerateCode">
      <intents name="CodeGeneration">
        <params name="language = C++"/>
        <params name="framework = ESP-IDF"/>
      </intents>
      <traceLinks name="ESP32_Task -> temp_control_task()"/>
      <traceLinks name="ADC_Pin -> adc1_get_raw()"/>
    </contains>
  </nodes>

  <!-- L4 Trace (energy optimized PSM) - has ancestor link -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_EnergyPIM2PSM"
         conformsTo="//@nodes.2"
         ancestor="//@nodes.39">
    <contains name="MapToLowPowerMCU">
      <intents name="LowPowerMapping">
        <params name="platform = STM32L4"/>
        <params name="sleep_current = 1uA"/>
      </intents>
      <traceLinks name="DutyCycleControl -> PWM_Timer"/>
      <traceLinks name="DeepSleepManager -> RTC_Wakeup"/>
    </contains>
  </nodes>

  <!-- L4 Trace (low power code generation) - has ancestor link -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_EnergyOptPIM2PSM"
         conformsTo="//@nodes.2"
         ancestor="//@nodes.51">
    <contains name="GenerateLowPowerCode">
      <intents name="PowerAwareCodeGen">
        <params name="language = C"/>
        <params name="optimize = size_and_power"/>
      </intents>
      <traceLinks name="PWM_Timer -> HAL_TIM_PWM_Start()"/>
      <traceLinks name="RTC_Wakeup -> HAL_PWR_EnterSLEEPMode()"/>
    </contains>
  </nodes>

</mpm_trace:Canvas>

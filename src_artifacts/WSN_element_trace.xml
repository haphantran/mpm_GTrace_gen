<?xml version="1.0" encoding="utf-8"?>
<mpm_trace:Canvas xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:mpm_trace="domain://MPM_trace">

  <!-- ========== METAMODELS ========== -->

  <!-- [0] Base Metamodel -->
  <nodes xmi:type="mpm_trace:MetaModel" name="Ecore"/>

  <!-- [1] M2M Transformation Metamodel -->
  <nodes xmi:type="mpm_trace:MetaModel" name="ATL"/>

  <!-- [2] M2T Transformation Metamodel -->
  <nodes xmi:type="mpm_trace:MetaModel" name="Acceleo"/>

  <!-- [3] Trace Metamodel -->
  <nodes xmi:type="mpm_trace:MetaModel" name="LTrace" conformsTo="//@nodes.0"/>

  <!-- [4] Domain Metamodels -->
  <nodes xmi:type="mpm_trace:MetaModel" name="GlobalViewMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PSMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="SystemDiagramMM" conformsTo="//@nodes.0"/>

  <!-- [7] Code Metamodel -->
  <nodes xmi:type="mpm_trace:MetaModel" name="C_MM" conformsTo="//@nodes.0"/>

  <!-- ========== VIEWPOINTS ========== -->

  <!-- [8] -->
  <nodes xmi:type="mpm_trace:Viewpoint" name="NetworkViewpoint"/>

  <!-- [9] -->
  <nodes xmi:type="mpm_trace:Viewpoint" name="SensorDataViewpoint"/>

  <!-- ========== ROLES ========== -->

  <!-- [10] -->
  <nodes xmi:type="mpm_trace:IoT_Engineer" name="IoTEngineer"/>

  <!-- [11] -->
  <nodes xmi:type="mpm_trace:Embedded_System_Engineer" name="EmbeddedSystemEngineer"/>

  <!-- ========== MODELS ========== -->

  <!-- [12] L0 Input: GlobalView Model -->
  <nodes xmi:type="mpm_trace:Model" name="GlobalView"
         conformsTo="//@nodes.4"
         associatedWith="//@nodes.10"
         In="//@nodes.16 //@nodes.17 //@nodes.18"/>

  <!-- [13] L0 Output: Arduino PSM -->
  <nodes xmi:type="mpm_trace:Model" name="Arduino_PSM"
         conformsTo="//@nodes.5"
         representedAs="//@nodes.8 //@nodes.9"
         associatedWith="//@nodes.11"
         In="//@nodes.20 //@nodes.23"/>

  <!-- [14] L0 Output: RIOT PSM -->
  <nodes xmi:type="mpm_trace:Model" name="RIOT_PSM"
         conformsTo="//@nodes.5"
         representedAs="//@nodes.8 //@nodes.9"
         associatedWith="//@nodes.11"
         In="//@nodes.20"/>

  <!-- [15] L0 Output: Contiki PSM -->
  <nodes xmi:type="mpm_trace:Model" name="Contiki_PSM"
         conformsTo="//@nodes.5"
         representedAs="//@nodes.8 //@nodes.9"
         associatedWith="//@nodes.11"
         In="//@nodes.20"/>

  <!-- ========== L0 TRANSFORMATIONS (GlobalView → PSMs) ========== -->

  <!-- [16] L0: GlobalView → Arduino -->
  <nodes xmi:type="mpm_trace:Transformation" name="GenArduino"
         conformsTo="//@nodes.1"
         Out="//@nodes.13"
         exec="//@nodes.26"/>

  <!-- [17] L0: GlobalView → RIOT -->
  <nodes xmi:type="mpm_trace:Transformation" name="GenRIOT"
         conformsTo="//@nodes.1"
         Out="//@nodes.14"
         exec="//@nodes.27"/>

  <!-- [18] L0: GlobalView → Contiki -->
  <nodes xmi:type="mpm_trace:Transformation" name="GenContiki"
         conformsTo="//@nodes.1"
         Out="//@nodes.15"
         exec="//@nodes.28"/>

  <!-- [19] L1 Output: System Diagram (integration point) -->
  <nodes xmi:type="mpm_trace:Model" name="SystemDiagram"
         conformsTo="//@nodes.6"
         associatedWith="//@nodes.11"/>

  <!-- ========== L1 TRANSFORMATION (PSMs → System Diagram) ========== -->

  <!-- [20] L1: PSMs → System Diagram -->
  <nodes xmi:type="mpm_trace:Transformation" name="PSM2SystemDiagram"
         conformsTo="//@nodes.1"
         Out="//@nodes.19"
         exec="//@nodes.29"/>

  <!-- [21] L2 Output: Arduino C Code -->
  <nodes xmi:type="mpm_trace:Model" name="Arduino_C_Code"
         conformsTo="//@nodes.7"
         associatedWith="//@nodes.11"/>

  <!-- [22] L2 Output: RIOT C Code -->
  <nodes xmi:type="mpm_trace:Model" name="RIOT_C_Code"
         conformsTo="//@nodes.7"
         associatedWith="//@nodes.11"/>

  <!-- ========== L2 TRANSFORMATIONS (PSMs → Code) ========== -->

  <!-- [23] L2: Arduino PSM → Arduino C Code -->
  <nodes xmi:type="mpm_trace:Transformation" name="Arduino2Code"
         conformsTo="//@nodes.2"
         Out="//@nodes.21"
         exec="//@nodes.30"/>

  <!-- [24] L2: RIOT PSM → RIOT C Code -->
  <nodes xmi:type="mpm_trace:Transformation" name="RIOT2Code"
         conformsTo="//@nodes.2"
         Out="//@nodes.22"
         exec="//@nodes.31"/>

  <!-- ========== EXECUTION HISTORY ========== -->

  <!-- [25] Unused placeholder -->
  <nodes xmi:type="mpm_trace:MetaModel" name="Placeholder"/>

  <!-- [26] L0 Execution: GenArduino -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_GenArduino_v1"
         generates="//@nodes.32"/>

  <!-- [27] L0 Execution: GenRIOT -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_GenRIOT_v1"
         generates="//@nodes.33"/>

  <!-- [28] L0 Execution: GenContiki -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_GenContiki_v1"
         generates="//@nodes.34"/>

  <!-- [29] L1 Execution: PSM2SystemDiagram -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PSM2SD_v1"
         generates="//@nodes.35"/>

  <!-- [30] L2 Execution: Arduino → C Code -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Arduino2C_v1"
         generates="//@nodes.36"/>

  <!-- [31] L2 Execution: RIOT → C Code -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_RIOT2C_v1"
         generates="//@nodes.37"/>

  <!-- ========== TRACES ========== -->

  <!-- [32] L0 Trace: GlobalView → Arduino PSM (WITH ELEMENT-LEVEL DETAILS) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_GenArduino_v1"
         conformsTo="//@nodes.3"
         version="1">
    <contains name="MapTemperatureSensor">
      <intents name="PlatformMapping">
        <params name="targetPlatform = Arduino"/>
        <params name="sensorLibrary = DHT22"/>
      </intents>

      <!-- MODEL-LEVEL trace -->
      <traceLinks name="GlobalView -> Arduino_PSM"/>

      <!-- ELEMENT-LEVEL trace: TemperatureSensor -> ArduinoTempSensor -->
      <traceLinks name="TemperatureSensor -> ArduinoTempSensor"
                  sourceElementPath="GlobalView::Sensors::TemperatureSensor"
                  targetElementPath="Arduino_PSM::Components::ArduinoTempSensor"
                  linkType="transforms"/>

      <!-- ATTRIBUTE-LEVEL trace: sampleRate -> pollInterval -->
      <traceLinks name="sampleRate -> pollInterval"
                  sourceElementPath="GlobalView::Sensors::TemperatureSensor"
                  targetElementPath="Arduino_PSM::Components::ArduinoTempSensor"
                  sourceAttribute="sampleRate"
                  targetAttribute="pollInterval"
                  linkType="maps"/>

      <!-- ATTRIBUTE-LEVEL trace: transmitPower -> txPower -->
      <traceLinks name="transmitPower -> txPower"
                  sourceElementPath="GlobalView::Sensors::TemperatureSensor"
                  targetElementPath="Arduino_PSM::Components::ArduinoTempSensor"
                  sourceAttribute="transmitPower"
                  targetAttribute="txPower"
                  linkType="maps"/>
    </contains>
  </nodes>

  <!-- [33] L0 Trace: GlobalView → RIOT PSM (model-level only) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_GenRIOT_v1"
         conformsTo="//@nodes.3"
         version="1">
    <contains name="MapToRIOT">
      <intents name="PlatformMapping">
        <params name="targetPlatform = RIOT"/>
      </intents>
      <traceLinks name="GlobalView -> RIOT_PSM"/>
      <traceLinks name="SensorNodes -> RIOT_Threads"/>
    </contains>
  </nodes>

  <!-- [34] L0 Trace: GlobalView → Contiki PSM (model-level only) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_GenContiki_v1"
         conformsTo="//@nodes.3"
         version="1">
    <contains name="MapToContiki">
      <intents name="PlatformMapping">
        <params name="targetPlatform = Contiki"/>
      </intents>
      <traceLinks name="GlobalView -> Contiki_PSM"/>
      <traceLinks name="SensorNodes -> Contiki_Processes"/>
    </contains>
  </nodes>

  <!-- [35] L1 Trace: PSMs → System Diagram (model-level only) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PSM2SD_v1"
         conformsTo="//@nodes.3"
         version="1">
    <contains name="IntegrateMultiPlatform">
      <intents name="SystemIntegration">
        <params name="topology = mesh"/>
      </intents>
      <traceLinks name="Arduino_PSM -> ArduinoNodes"/>
      <traceLinks name="RIOT_PSM -> RIOTNodes"/>
      <traceLinks name="Contiki_PSM -> ContikiNodes"/>
    </contains>
  </nodes>

  <!-- [36] L2 Trace: Arduino PSM → C Code (WITH ELEMENT-LEVEL DETAILS) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Arduino2C_v1"
         conformsTo="//@nodes.3"
         version="1">
    <contains name="GenerateSensorCode">
      <intents name="CodeGeneration">
        <params name="language = C"/>
        <params name="template = arduino_sensor.c"/>
      </intents>

      <!-- MODEL-LEVEL trace -->
      <traceLinks name="Arduino_PSM -> Arduino_C_Code"/>

      <!-- ELEMENT-LEVEL trace: ArduinoTempSensor -> setup() function -->
      <traceLinks name="ArduinoTempSensor -> setup()"
                  sourceElementPath="Arduino_PSM::Components::ArduinoTempSensor"
                  targetElementPath="Arduino_C_Code::Functions::setup"
                  linkType="generates"/>

      <!-- ATTRIBUTE-LEVEL trace: pollInterval -> POLL_INTERVAL constant -->
      <traceLinks name="pollInterval -> POLL_INTERVAL"
                  sourceElementPath="Arduino_PSM::Components::ArduinoTempSensor"
                  targetElementPath="Arduino_C_Code::Constants::POLL_INTERVAL"
                  sourceAttribute="pollInterval"
                  targetAttribute="value"
                  linkType="derives"/>

      <!-- ATTRIBUTE-LEVEL trace: txPower -> TX_POWER constant -->
      <traceLinks name="txPower -> TX_POWER"
                  sourceElementPath="Arduino_PSM::Components::ArduinoTempSensor"
                  targetElementPath="Arduino_C_Code::Constants::TX_POWER"
                  sourceAttribute="txPower"
                  targetAttribute="value"
                  linkType="derives"/>
    </contains>
  </nodes>

  <!-- [37] L2 Trace: RIOT PSM → C Code (model-level only) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_RIOT2C_v1"
         conformsTo="//@nodes.3"
         version="1">
    <contains name="GenerateRIOTCode">
      <intents name="CodeGeneration">
        <params name="language = C"/>
        <params name="template = riot_sensor.c"/>
      </intents>
      <traceLinks name="RIOT_PSM -> RIOT_C_Code"/>
      <traceLinks name="Threads -> main() and thread functions"/>
    </contains>
  </nodes>

</mpm_trace:Canvas>

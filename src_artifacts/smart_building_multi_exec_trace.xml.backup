<?xml version="1.0" encoding="utf-8"?>
<mpm_trace:Canvas xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:mpm_trace="domain://MPM_trace">

  <!-- ========== METAMODELS (Level 0 - Foundation) ========== -->
  <nodes xmi:type="mpm_trace:MetaModel" name="Ecore"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="UML" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="SysML" conformsTo="//@nodes.1"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="ATL"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="LTrace" conformsTo="//@nodes.0"/>

  <!-- Domain-specific metamodels -->
  <nodes xmi:type="mpm_trace:MetaModel" name="SmartBuildingMM" conformsTo="//@nodes.2"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="SensorNetworkMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="EnergyManagementMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PlatformIndependentMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PlatformSpecificMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="CodeGenerationMM" conformsTo="//@nodes.0"/>

  <!-- ========== VIEWPOINTS ========== -->
  <nodes xmi:type="mpm_trace:Viewpoint" name="Energy Consumption Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Network Topology Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Security Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Real-Time Performance Viewpoint"/>

  <!-- ========== ROLES ========== -->
  <nodes xmi:type="mpm_trace:IoT_Engineer" name="IoT System Engineer"/>
  <nodes xmi:type="mpm_trace:Network_Engineer" name="Building Network Architect"/>
  <nodes xmi:type="mpm_trace:Data_Engineer" name="Building Data Analyst"/>
  <nodes xmi:type="mpm_trace:Embedded_System_Engineer" name="Embedded Systems Developer"/>

  <!-- ========== LEVEL 1: Requirements to System Architecture ========== -->

  <!-- L1 Input: Requirements Model -->
  <nodes xmi:type="mpm_trace:Model" name="SmartBuildingRequirements"
         conformsTo="//@nodes.5"
         In="//@nodes.21"
         associatedWith="//@nodes.16 //@nodes.17"/>

  <!-- L1 Transformation (MULTIPLE EXECUTIONS) -->
  <nodes xmi:type="mpm_trace:Transformation" name="Requirements2SystemArchitecture"
         exec="//@nodes.22 //@nodes.23 //@nodes.24"
         Out="//@nodes.25 //@nodes.26 //@nodes.27"
         conformsTo="//@nodes.3"/>

  <!-- L1 Execution V1 - Initial design -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Req2SysArch_v1.0"
         generates="//@nodes.28"/>

  <!-- L1 Execution V2 - Optimized for energy -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Req2SysArch_v2.0_EnergyOptimized"
         generates="//@nodes.29"/>

  <!-- L1 Execution V3 - Security hardened -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Req2SysArch_v3.0_SecureMode"
         generates="//@nodes.30"/>

  <!-- L1 Output V1: System Architecture Model (baseline) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingSystemArchitecture_v1"
         conformsTo="//@nodes.5"
         In="//@nodes.33"
         representedAs="//@nodes.11 //@nodes.12 //@nodes.13"
         associatedWith="//@nodes.16"/>

  <!-- L1 Output V2: System Architecture Model (energy optimized) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingSystemArchitecture_v2_EnergyOptimized"
         conformsTo="//@nodes.5"
         In="//@nodes.47"
         representedAs="//@nodes.11 //@nodes.12"
         associatedWith="//@nodes.16"/>

  <!-- L1 Output V3: System Architecture Model (secure) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingSystemArchitecture_v3_Secure"
         conformsTo="//@nodes.5"
         representedAs="//@nodes.11 //@nodes.13 //@nodes.14"
         associatedWith="//@nodes.16"/>

  <!-- L1 Trace Model V1 (baseline) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Req2SysArch_v1.0" conformsTo="//@nodes.4">
    <contains name="DecomposeEnergyManagementRequirement">
      <intents name="DecomposeRequirement">
        <params name="requirement_id = REQ-EM-001"/>
        <params name="decomposition_strategy = functional"/>
        <params name="version = 1.0"/>
      </intents>
      <traceLinks name="EnergyManagementReq -> HVACController"/>
      <traceLinks name="EnergyManagementReq -> LightingController"/>
      <traceLinks name="EnergyManagementReq -> OccupancyDetector"/>
    </contains>
    <contains name="AllocateSensorToZone">
      <intents name="SpatialAllocation">
        <params name="zone_type = conference_room"/>
        <params name="sensor_coverage = 25m2"/>
        <params name="sensor_density = normal"/>
      </intents>
      <traceLinks name="TemperatureMonitoring -> TempSensor_Zone1"/>
      <traceLinks name="OccupancyMonitoring -> PIRSensor_Zone1"/>
    </contains>
  </nodes>

  <!-- L1 Trace Model V2 (energy optimized) - VARIANT -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Req2SysArch_v2.0_EnergyOptimized" conformsTo="//@nodes.4">
    <contains name="DecomposeEnergyManagementRequirement">
      <intents name="DecomposeRequirement">
        <params name="requirement_id = REQ-EM-001"/>
        <params name="decomposition_strategy = energy_aware"/>
        <params name="version = 2.0"/>
        <params name="optimization_target = reduce_power_30%"/>
      </intents>
      <traceLinks name="EnergyManagementReq -> AdaptiveHVACController"/>
      <traceLinks name="EnergyManagementReq -> SmartLightingController_DimmingEnabled"/>
      <traceLinks name="EnergyManagementReq -> MultiModalOccupancyDetector"/>
      <traceLinks name="EnergyManagementReq -> SleepModeScheduler"/>
    </contains>
    <contains name="AllocateSensorToZone">
      <intents name="SpatialAllocation">
        <params name="zone_type = conference_room"/>
        <params name="sensor_coverage = 30m2"/>
        <params name="sensor_density = reduced_for_efficiency"/>
        <params name="power_mode = low_power"/>
      </intents>
      <traceLinks name="TemperatureMonitoring -> LowPowerTempSensor_Zone1"/>
      <traceLinks name="OccupancyMonitoring -> CombinedPIR_UltrasonicSensor_Zone1"/>
    </contains>
    <contains name="AddEnergyHarvestingSupport">
      <intents name="EnergyHarvesting">
        <params name="harvesting_type = solar"/>
        <params name="battery_backup = true"/>
      </intents>
      <traceLinks name="PowerRequirement -> SolarPanel"/>
      <traceLinks name="PowerRequirement -> BatteryBackup"/>
    </contains>
  </nodes>

  <!-- L1 Trace Model V3 (security hardened) - VARIANT -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Req2SysArch_v3.0_SecureMode" conformsTo="//@nodes.4">
    <contains name="DecomposeEnergyManagementRequirement">
      <intents name="DecomposeRequirement">
        <params name="requirement_id = REQ-EM-001"/>
        <params name="decomposition_strategy = security_first"/>
        <params name="version = 3.0"/>
        <params name="security_level = high"/>
      </intents>
      <traceLinks name="EnergyManagementReq -> SecureHVACController_TLS"/>
      <traceLinks name="EnergyManagementReq -> AuthenticatedLightingController"/>
      <traceLinks name="EnergyManagementReq -> TamperProofOccupancyDetector"/>
      <traceLinks name="EnergyManagementReq -> SecurityAuditLogger"/>
    </contains>
    <contains name="AllocateSensorToZone">
      <intents name="SpatialAllocation">
        <params name="zone_type = conference_room"/>
        <params name="sensor_coverage = 25m2"/>
        <params name="sensor_density = normal"/>
        <params name="authentication = required"/>
        <params name="encryption = AES256"/>
      </intents>
      <traceLinks name="TemperatureMonitoring -> AuthenticatedTempSensor_Zone1"/>
      <traceLinks name="OccupancyMonitoring -> SecurePIRSensor_Zone1"/>
    </contains>
    <contains name="AddSecurityComponents">
      <intents name="SecurityHardening">
        <params name="intrusion_detection = enabled"/>
        <params name="secure_boot = enabled"/>
      </intents>
      <traceLinks name="SecurityReq -> IntrusionDetectionSystem"/>
      <traceLinks name="SecurityReq -> SecureBootManager"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 2: System Architecture to Platform-Independent Design ========== -->

  <!-- L2 Transformation (based on v1 baseline) -->
  <nodes xmi:type="mpm_trace:Transformation" name="SystemArch2PlatformIndependent"
         exec="//@nodes.34 //@nodes.35"
         Out="//@nodes.36 //@nodes.37"
         conformsTo="//@nodes.3"/>

  <!-- L2 Execution V1 -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_SysArch2PIM_v1.0"
         generates="//@nodes.38"/>

  <!-- L2 Execution V2 - Alternative algorithm selection -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_SysArch2PIM_v2.0_FuzzyLogic"
         generates="//@nodes.39"/>

  <!-- L2 Output V1: Platform-Independent Model (PID control) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPIM_v1_PID"
         conformsTo="//@nodes.8"
         In="//@nodes.40"
         representedAs="//@nodes.11 //@nodes.12"
         associatedWith="//@nodes.16 //@nodes.18"/>

  <!-- L2 Output V2: Platform-Independent Model (Fuzzy logic) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPIM_v2_FuzzyLogic"
         conformsTo="//@nodes.8"
         In="//@nodes.54"
         representedAs="//@nodes.11 //@nodes.12"
         associatedWith="//@nodes.16 //@nodes.18"/>

  <!-- L2 Trace Model V1 (PID) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_SysArch2PIM_v1.0_PID" conformsTo="//@nodes.4">
    <contains name="RefineHVACControlLogic">
      <intents name="BehaviorRefinement">
        <params name="control_algorithm = PID"/>
        <params name="sampling_rate = 1Hz"/>
        <params name="setpoint_range = 18-24°C"/>
        <params name="version = 1.0"/>
      </intents>
      <traceLinks name="HVACController -> TemperatureControlLoop"/>
      <traceLinks name="HVACController -> PIDController"/>
      <traceLinks name="TempSensor -> TemperatureInput"/>
    </contains>
    <contains name="DefineDataFlowPattern">
      <intents name="DataFlowSpecification">
        <params name="communication_pattern = publish-subscribe"/>
        <params name="qos_level = 1"/>
      </intents>
      <traceLinks name="OccupancyDetector -> OccupancyPublisher"/>
      <traceLinks name="LightingController -> LightingSubscriber"/>
    </contains>
  </nodes>

  <!-- L2 Trace Model V2 (Fuzzy Logic) - VARIANT -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_SysArch2PIM_v2.0_FuzzyLogic" conformsTo="//@nodes.4">
    <contains name="RefineHVACControlLogic">
      <intents name="BehaviorRefinement">
        <params name="control_algorithm = FuzzyLogic"/>
        <params name="sampling_rate = 0.5Hz"/>
        <params name="setpoint_range = 18-24°C"/>
        <params name="fuzzy_sets = 5"/>
        <params name="inference_method = Mamdani"/>
        <params name="version = 2.0"/>
      </intents>
      <traceLinks name="HVACController -> TemperatureControlLoop"/>
      <traceLinks name="HVACController -> FuzzyLogicController"/>
      <traceLinks name="HVACController -> FuzzificationModule"/>
      <traceLinks name="HVACController -> InferenceEngine"/>
      <traceLinks name="HVACController -> DefuzzificationModule"/>
      <traceLinks name="TempSensor -> TemperatureInput"/>
      <traceLinks name="OccupancySensor -> OccupancyInput"/>
    </contains>
    <contains name="DefineDataFlowPattern">
      <intents name="DataFlowSpecification">
        <params name="communication_pattern = publish-subscribe"/>
        <params name="qos_level = 2"/>
        <params name="message_persistence = true"/>
      </intents>
      <traceLinks name="OccupancyDetector -> OccupancyPublisher"/>
      <traceLinks name="LightingController -> LightingSubscriber"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 3: Platform-Independent to Platform-Specific Design ========== -->

  <!-- L3 Transformation (MULTIPLE EXECUTIONS for different platforms) -->
  <nodes xmi:type="mpm_trace:Transformation" name="PIM2PlatformSpecific"
         exec="//@nodes.41 //@nodes.42 //@nodes.43"
         Out="//@nodes.44 //@nodes.45 //@nodes.46"
         conformsTo="//@nodes.3"/>

  <!-- L3 Execution V1 - ESP32 target -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2PSM_ESP32"
         generates="//@nodes.48"/>

  <!-- L3 Execution V2 - Arduino target -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2PSM_Arduino"
         generates="//@nodes.49"/>

  <!-- L3 Execution V3 - RIOT OS target -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2PSM_RIOT"
         generates="//@nodes.50"/>

  <!-- L3 Output V1: ESP32 Platform-Specific Model -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPSM_ESP32"
         conformsTo="//@nodes.9"
         In="//@nodes.51"
         representedAs="//@nodes.11 //@nodes.13 //@nodes.14"
         associatedWith="//@nodes.19"/>

  <!-- L3 Output V2: Arduino Platform-Specific Model -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPSM_Arduino"
         conformsTo="//@nodes.9"
         In="//@nodes.61"
         representedAs="//@nodes.11"
         associatedWith="//@nodes.19"/>

  <!-- L3 Output V3: RIOT OS Platform-Specific Model -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPSM_RIOT"
         conformsTo="//@nodes.9"
         In="//@nodes.64"
         representedAs="//@nodes.13 //@nodes.14"
         associatedWith="//@nodes.19"/>

  <!-- L3 Transformation (energy optimized path) -->
  <nodes xmi:type="mpm_trace:Transformation" name="EnergyOptArch2PlatformSpecific"
         exec="//@nodes.52"
         Out="//@nodes.53"
         conformsTo="//@nodes.3"/>

  <!-- L3 Trace Model V1 (ESP32) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2PSM_ESP32" conformsTo="//@nodes.4">
    <contains name="MapPIDToESP32">
      <intents name="PlatformMapping">
        <params name="target_platform = ESP32"/>
        <params name="clock_speed = 240MHz"/>
        <params name="memory_constraint = 520KB_SRAM"/>
        <params name="version = 1.0"/>
      </intents>
      <traceLinks name="PIDController -> ESP32_PID_Task"/>
      <traceLinks name="TemperatureInput -> ADC_Channel_0"/>
      <traceLinks name="HVACOutput -> GPIO_PWM_Pin_25"/>
    </contains>
    <contains name="SelectCommunicationProtocol">
      <intents name="ProtocolSelection">
        <params name="protocol = MQTT"/>
        <params name="broker = mosquitto"/>
        <params name="network = WiFi_802.11n"/>
      </intents>
      <traceLinks name="OccupancyPublisher -> MQTT_Publisher"/>
      <traceLinks name="LightingSubscriber -> MQTT_Subscriber"/>
    </contains>
  </nodes>

  <!-- L3 Trace Model V2 (Arduino) - VARIANT -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2PSM_Arduino" conformsTo="//@nodes.4">
    <contains name="MapPIDToArduino">
      <intents name="PlatformMapping">
        <params name="target_platform = Arduino_Uno"/>
        <params name="clock_speed = 16MHz"/>
        <params name="memory_constraint = 2KB_SRAM"/>
        <params name="version = 1.0"/>
      </intents>
      <traceLinks name="PIDController -> Arduino_PID_Loop"/>
      <traceLinks name="TemperatureInput -> AnalogPin_A0"/>
      <traceLinks name="HVACOutput -> DigitalPin_PWM_9"/>
    </contains>
    <contains name="SelectCommunicationProtocol">
      <intents name="ProtocolSelection">
        <params name="protocol = Serial"/>
        <params name="baud_rate = 9600"/>
        <params name="communication = wired"/>
      </intents>
      <traceLinks name="OccupancyPublisher -> Serial_TX"/>
      <traceLinks name="LightingSubscriber -> Serial_RX"/>
    </contains>
    <contains name="OptimizeMemoryUsage">
      <intents name="MemoryOptimization">
        <params name="strategy = minimize_buffers"/>
        <params name="use_progmem = true"/>
      </intents>
      <traceLinks name="ControlLogic -> FlashMemory_PROGMEM"/>
    </contains>
  </nodes>

  <!-- L3 Trace Model V3 (RIOT) - VARIANT -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2PSM_RIOT" conformsTo="//@nodes.4">
    <contains name="MapPIDToRIOT">
      <intents name="PlatformMapping">
        <params name="target_platform = RIOT_OS"/>
        <params name="board = nrf52840"/>
        <params name="clock_speed = 64MHz"/>
        <params name="memory_constraint = 256KB_RAM"/>
        <params name="version = 1.0"/>
      </intents>
      <traceLinks name="PIDController -> RIOT_Thread_PID"/>
      <traceLinks name="TemperatureInput -> ADC_RIOT"/>
      <traceLinks name="HVACOutput -> GPIO_RIOT"/>
    </contains>
    <contains name="SelectCommunicationProtocol">
      <intents name="ProtocolSelection">
        <params name="protocol = CoAP"/>
        <params name="network = 6LoWPAN"/>
        <params name="transport = UDP"/>
      </intents>
      <traceLinks name="OccupancyPublisher -> CoAP_POST"/>
      <traceLinks name="LightingSubscriber -> CoAP_Observe"/>
    </contains>
    <contains name="ConfigureRIOTModules">
      <intents name="OSConfiguration">
        <params name="scheduler = RIOT_sched"/>
        <params name="network_stack = gnrc"/>
      </intents>
      <traceLinks name="TaskScheduler -> RIOT_Scheduler"/>
    </contains>
  </nodes>

  <!-- L3 Execution (energy optimized) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_EnergyOptArch2PSM"
         generates="//@nodes.55"/>

  <!-- L3 Output (energy optimized) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPSM_EnergyOpt"
         conformsTo="//@nodes.9"
         representedAs="//@nodes.11"
         associatedWith="//@nodes.19"/>

  <!-- L3 Transformation (Fuzzy to platform) -->
  <nodes xmi:type="mpm_trace:Transformation" name="FuzzyPIM2PlatformSpecific"
         exec="//@nodes.56"
         Out="//@nodes.57"
         conformsTo="//@nodes.3"/>

  <!-- L3 Trace Model (energy optimized) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_EnergyOptArch2PSM" conformsTo="//@nodes.4">
    <contains name="MapToLowPowerMCU">
      <intents name="PlatformMapping">
        <params name="target_platform = STM32L4"/>
        <params name="power_mode = ultra_low_power"/>
        <params name="sleep_modes = enabled"/>
      </intents>
      <traceLinks name="AdaptiveHVACController -> STM32L4_LowPower_Task"/>
      <traceLinks name="SleepModeScheduler -> RTC_Wakeup"/>
    </contains>
  </nodes>

  <!-- L3 Execution (Fuzzy) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_FuzzyPIM2PSM"
         generates="//@nodes.58"/>

  <!-- L3 Output (Fuzzy) -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPSM_Fuzzy"
         conformsTo="//@nodes.9"
         In="//@nodes.59"
         associatedWith="//@nodes.19"/>

  <!-- L3 Trace Model (Fuzzy) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_FuzzyPIM2PSM" conformsTo="//@nodes.4">
    <contains name="MapFuzzyLogicToESP32">
      <intents name="PlatformMapping">
        <params name="target_platform = ESP32"/>
        <params name="fuzzy_library = eFLL"/>
        <params name="version = 2.0"/>
      </intents>
      <traceLinks name="FuzzyLogicController -> ESP32_Fuzzy_Task"/>
      <traceLinks name="FuzzificationModule -> Fuzzify_Function"/>
      <traceLinks name="InferenceEngine -> RuleEvaluation_Function"/>
      <traceLinks name="DefuzzificationModule -> Defuzzify_Function"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 4: Platform-Specific to Code Generation ========== -->

  <!-- L4 Transformation (ESP32) -->
  <nodes xmi:type="mpm_trace:Transformation" name="PSM2CodeGeneration_ESP32"
         exec="//@nodes.60"
         Out="//@nodes.62"
         conformsTo="//@nodes.3"/>

  <!-- L4 Execution (ESP32) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PSM2Code_ESP32"
         generates="//@nodes.63"/>

  <!-- L4 Transformation (Arduino) -->
  <nodes xmi:type="mpm_trace:Transformation" name="PSM2CodeGeneration_Arduino"
         exec="//@nodes.65"
         Out="//@nodes.66"
         conformsTo="//@nodes.3"/>

  <!-- L4 Output (ESP32) -->
  <nodes xmi:type="mpm_trace:Model" name="ESP32_FirmwareCode"
         conformsTo="//@nodes.10"
         In="//@nodes.67"
         associatedWith="//@nodes.19"/>

  <!-- L4 Trace Model (ESP32) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PSM2Code_ESP32" conformsTo="//@nodes.4">
    <contains name="GeneratePIDControlCode">
      <intents name="CodeGeneration">
        <params name="language = C++"/>
        <params name="framework = ESP-IDF"/>
        <params name="optimization_level = O2"/>
      </intents>
      <traceLinks name="ESP32_PID_Task -> pid_control_task()"/>
      <traceLinks name="ADC_Channel_0 -> adc1_get_raw(ADC1_CHANNEL_0)"/>
      <traceLinks name="GPIO_PWM_Pin_25 -> ledc_set_duty()"/>
    </contains>
    <contains name="GenerateMQTTClientCode">
      <intents name="CommunicationCodeGen">
        <params name="mqtt_library = PubSubClient"/>
        <params name="reconnect_strategy = exponential_backoff"/>
      </intents>
      <traceLinks name="MQTT_Publisher -> publishOccupancy()"/>
      <traceLinks name="MQTT_Subscriber -> subscribeToLighting()"/>
    </contains>
  </nodes>

  <!-- L4 Transformation (RIOT) -->
  <nodes xmi:type="mpm_trace:Transformation" name="PSM2CodeGeneration_RIOT"
         exec="//@nodes.68"
         Out="//@nodes.69"
         conformsTo="//@nodes.3"/>

  <!-- L4 Execution (Arduino) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PSM2Code_Arduino"
         generates="//@nodes.70"/>

  <!-- L4 Output (Arduino) -->
  <nodes xmi:type="mpm_trace:Model" name="Arduino_SensorCode"
         conformsTo="//@nodes.10"
         In="//@nodes.71"
         associatedWith="//@nodes.19"/>

  <!-- ========== LEVEL 5: Code to Deployment ========== -->

  <!-- L5 Transformation (ESP32) -->
  <nodes xmi:type="mpm_trace:Transformation" name="Code2Deployment_ESP32"
         exec="//@nodes.72"
         Out="//@nodes.73"
         conformsTo="//@nodes.3"/>

  <!-- L5 Execution (RIOT) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PSM2Code_RIOT"
         generates="//@nodes.74"/>

  <!-- L5 Output (RIOT) -->
  <nodes xmi:type="mpm_trace:Model" name="RIOT_FirmwareCode"
         conformsTo="//@nodes.10"
         associatedWith="//@nodes.19"/>

  <!-- L4 Trace Model (Arduino) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PSM2Code_Arduino" conformsTo="//@nodes.4">
    <contains name="GenerateArduinoSketch">
      <intents name="CodeGeneration">
        <params name="language = C++"/>
        <params name="framework = Arduino"/>
        <params name="memory_optimization = aggressive"/>
      </intents>
      <traceLinks name="Arduino_PID_Loop -> loop()"/>
      <traceLinks name="AnalogPin_A0 -> analogRead(A0)"/>
      <traceLinks name="DigitalPin_PWM_9 -> analogWrite(9, value)"/>
    </contains>
  </nodes>

  <!-- L5 Transformation (Arduino) -->
  <nodes xmi:type="mpm_trace:Transformation" name="Code2Deployment_Arduino"
         exec="//@nodes.72"
         Out="//@nodes.73"
         conformsTo="//@nodes.3"/>

  <!-- L5 Execution (ESP32) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Code2Deploy_ESP32"
         generates="//@nodes.74"/>

  <!-- L5 Output (ESP32) -->
  <nodes xmi:type="mpm_trace:Model" name="ESP32_DeploymentPackage"
         conformsTo="//@nodes.10"
         associatedWith="//@nodes.19"/>

  <!-- L4 Trace Model (RIOT) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PSM2Code_RIOT" conformsTo="//@nodes.4">
    <contains name="GenerateRIOTApplication">
      <intents name="CodeGeneration">
        <params name="language = C"/>
        <params name="os = RIOT"/>
        <params name="modules = gnrc_netif, gnrc_ipv6, gcoap"/>
      </intents>
      <traceLinks name="RIOT_Thread_PID -> pid_thread()"/>
      <traceLinks name="CoAP_POST -> gcoap_req_send()"/>
    </contains>
  </nodes>

  <!-- L5 Execution (Arduino) -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Code2Deploy_Arduino"
         generates="//@nodes.72"/>

  <!-- L5 Output (Arduino) -->
  <nodes xmi:type="mpm_trace:Model" name="Arduino_DeploymentPackage"
         conformsTo="//@nodes.10"
         associatedWith="//@nodes.19"/>

  <!-- L5 Trace Model (ESP32) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Code2Deploy_ESP32" conformsTo="//@nodes.4">
    <contains name="CompileForESP32">
      <intents name="CompilationConfig">
        <params name="target = xtensa-esp32"/>
        <params name="flash_size = 4MB"/>
        <params name="partition_scheme = default"/>
      </intents>
      <traceLinks name="ESP32_FirmwareCode -> firmware.bin"/>
    </contains>
    <contains name="GenerateOTAPackage">
      <intents name="OTAPreparation">
        <params name="ota_enabled = true"/>
        <params name="version = 1.2.3"/>
      </intents>
      <traceLinks name="firmware.bin -> firmware_ota.bin"/>
    </contains>
  </nodes>

  <!-- L5 Trace Model (Arduino) -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Code2Deploy_Arduino" conformsTo="//@nodes.4">
    <contains name="CompileArduinoSketch">
      <intents name="ArduinoCompilation">
        <params name="board = Arduino_Uno"/>
        <params name="programmer = USBtinyISP"/>
      </intents>
      <traceLinks name="Arduino_SensorCode -> sensor_sketch.hex"/>
    </contains>
  </nodes>

</mpm_trace:Canvas>

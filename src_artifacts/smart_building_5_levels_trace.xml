<?xml version="1.0" encoding="utf-8"?>
<mpm_trace:Canvas xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:mpm_trace="domain://MPM_trace">

  <!-- ========== METAMODELS (Level 0 - Foundation) ========== -->
  <nodes xmi:type="mpm_trace:MetaModel" name="Ecore"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="UML" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="SysML" conformsTo="//@nodes.1"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="ATL"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="LTrace" conformsTo="//@nodes.0"/>

  <!-- Domain-specific metamodels -->
  <nodes xmi:type="mpm_trace:MetaModel" name="SmartBuildingMM" conformsTo="//@nodes.2"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="SensorNetworkMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="EnergyManagementMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PlatformIndependentMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="PlatformSpecificMM" conformsTo="//@nodes.0"/>
  <nodes xmi:type="mpm_trace:MetaModel" name="CodeGenerationMM" conformsTo="//@nodes.0"/>

  <!-- ========== VIEWPOINTS ========== -->
  <nodes xmi:type="mpm_trace:Viewpoint" name="Energy Consumption Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Network Topology Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Security Viewpoint"/>
  <nodes xmi:type="mpm_trace:Viewpoint" name="Real-Time Performance Viewpoint"/>

  <!-- ========== ROLES ========== -->
  <nodes xmi:type="mpm_trace:IoT_Engineer" name="IoT System Engineer"/>
  <nodes xmi:type="mpm_trace:Network_Engineer" name="Building Network Architect"/>
  <nodes xmi:type="mpm_trace:Data_Engineer" name="Building Data Analyst"/>
  <nodes xmi:type="mpm_trace:Embedded_System_Engineer" name="Embedded Systems Developer"/>

  <!-- ========== LEVEL 1: Requirements to System Architecture ========== -->

  <!-- L1 Input: Requirements Model -->
  <nodes xmi:type="mpm_trace:Model" name="SmartBuildingRequirements"
         conformsTo="//@nodes.5"
         In="//@nodes.21"
         associatedWith="//@nodes.16 //@nodes.17"/>

  <!-- L1 Transformation -->
  <nodes xmi:type="mpm_trace:Transformation" name="Requirements2SystemArchitecture"
         exec="//@nodes.22"
         Out="//@nodes.23"
         conformsTo="//@nodes.3"/>

  <!-- L1 Execution -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Req2SysArch"
         generates="//@nodes.24"/>

  <!-- L1 Output: System Architecture Model -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingSystemArchitecture"
         conformsTo="//@nodes.5"
         In="//@nodes.25 //@nodes.32"
         representedAs="//@nodes.11 //@nodes.12 //@nodes.13"
         associatedWith="//@nodes.16"/>

  <!-- L1 Trace Model -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Req2SysArch" conformsTo="//@nodes.4">
    <contains name="DecomposeEnergyManagementRequirement">
      <intents name="DecomposeRequirement">
        <params name="requirement_id = REQ-EM-001"/>
        <params name="decomposition_strategy = functional"/>
      </intents>
      <traceLinks name="EnergyManagementReq -> HVACController"/>
      <traceLinks name="EnergyManagementReq -> LightingController"/>
      <traceLinks name="EnergyManagementReq -> OccupancyDetector"/>
    </contains>
    <contains name="AllocateSensorToZone">
      <intents name="SpatialAllocation">
        <params name="zone_type = conference_room"/>
        <params name="sensor_coverage = 25m2"/>
      </intents>
      <traceLinks name="TemperatureMonitoring -> TempSensor_Zone1"/>
      <traceLinks name="OccupancyMonitoring -> PIRSensor_Zone1"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 2: System Architecture to Platform-Independent Design ========== -->

  <!-- L2 Transformation -->
  <nodes xmi:type="mpm_trace:Transformation" name="SystemArch2PlatformIndependent"
         exec="//@nodes.26"
         Out="//@nodes.27"
         conformsTo="//@nodes.3"/>

  <!-- L2 Execution -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_SysArch2PIM"
         generates="//@nodes.28"/>

  <!-- L2 Output: Platform-Independent Model -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPIM"
         conformsTo="//@nodes.8"
         In="//@nodes.29 //@nodes.36"
         representedAs="//@nodes.11 //@nodes.12"
         associatedWith="//@nodes.16 //@nodes.18"/>

  <!-- L2 Trace Model -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_SysArch2PIM" conformsTo="//@nodes.4">
    <contains name="RefineHVACControlLogic">
      <intents name="BehaviorRefinement">
        <params name="control_algorithm = PID"/>
        <params name="sampling_rate = 1Hz"/>
        <params name="setpoint_range = 18-24Â°C"/>
      </intents>
      <traceLinks name="HVACController -> TemperatureControlLoop"/>
      <traceLinks name="HVACController -> PIDController"/>
      <traceLinks name="TempSensor -> TemperatureInput"/>
    </contains>
    <contains name="DefineDataFlowPattern">
      <intents name="DataFlowSpecification">
        <params name="communication_pattern = publish-subscribe"/>
        <params name="qos_level = 1"/>
      </intents>
      <traceLinks name="OccupancyDetector -> OccupancyPublisher"/>
      <traceLinks name="LightingController -> LightingSubscriber"/>
    </contains>
    <contains name="SpecifyEnergyOptimization">
      <intents name="OptimizationStrategy">
        <params name="objective = minimize_energy_consumption"/>
        <params name="constraint = maintain_comfort_level > 80%"/>
      </intents>
      <traceLinks name="EnergyManagementReq -> EnergyOptimizer"/>
      <traceLinks name="OccupancyData -> AdaptiveScheduler"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 3: Platform-Independent to Platform-Specific Design ========== -->

  <!-- L3 Transformation -->
  <nodes xmi:type="mpm_trace:Transformation" name="PIM2PlatformSpecific"
         exec="//@nodes.30"
         Out="//@nodes.31"
         conformsTo="//@nodes.3"/>

  <!-- L3 Execution -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2PSM"
         generates="//@nodes.33"/>

  <!-- L3 Output: Platform-Specific Model -->
  <nodes xmi:type="mpm_trace:Model" name="BuildingControlPSM"
         conformsTo="//@nodes.9"
         In="//@nodes.34 //@nodes.40 //@nodes.45"
         representedAs="//@nodes.11 //@nodes.13 //@nodes.14"
         associatedWith="//@nodes.19"/>

  <!-- Additional L3 Transformation for network decomposition -->
  <nodes xmi:type="mpm_trace:Transformation" name="SystemArch2SensorNetwork"
         exec="//@nodes.35"
         Out="//@nodes.37"
         conformsTo="//@nodes.3"/>

  <!-- L3 Trace Model for PIM2PSM -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2PSM" conformsTo="//@nodes.4">
    <contains name="MapPIDToESP32">
      <intents name="PlatformMapping">
        <params name="target_platform = ESP32"/>
        <params name="clock_speed = 240MHz"/>
        <params name="memory_constraint = 520KB_SRAM"/>
      </intents>
      <traceLinks name="PIDController -> ESP32_PID_Task"/>
      <traceLinks name="TemperatureInput -> ADC_Channel_0"/>
      <traceLinks name="HVACOutput -> GPIO_PWM_Pin"/>
    </contains>
    <contains name="SelectCommunicationProtocol">
      <intents name="ProtocolSelection">
        <params name="protocol = MQTT"/>
        <params name="broker = mosquitto"/>
        <params name="network = WiFi_802.11n"/>
      </intents>
      <traceLinks name="OccupancyPublisher -> MQTT_Publisher"/>
      <traceLinks name="LightingSubscriber -> MQTT_Subscriber"/>
    </contains>
    <contains name="AllocateMemoryBuffers">
      <intents name="MemoryManagement">
        <params name="sensor_buffer_size = 128_bytes"/>
        <params name="message_queue_depth = 10"/>
      </intents>
      <traceLinks name="TemperatureData -> SensorBuffer_0"/>
      <traceLinks name="OccupancyData -> SensorBuffer_1"/>
    </contains>
  </nodes>

  <!-- L3 Transformation for network decomposition -->
  <nodes xmi:type="mpm_trace:Transformation" name="PIM2NetworkTopology"
         exec="//@nodes.38"
         Out="//@nodes.39"
         conformsTo="//@nodes.3"/>

  <!-- L3 Execution for network -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PIM2Network"
         generates="//@nodes.41"/>

  <!-- L3 Output: Sensor Network Model -->
  <nodes xmi:type="mpm_trace:Model" name="SensorNetworkTopology"
         conformsTo="//@nodes.6"
         In="//@nodes.42"
         representedAs="//@nodes.12 //@nodes.14"
         associatedWith="//@nodes.17"/>

  <!-- L3 Execution for network decomposition -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_SysArch2SensorNet"
         generates="//@nodes.43"/>

  <!-- L3 Output: Network Configuration -->
  <nodes xmi:type="mpm_trace:Model" name="NetworkConfiguration"
         conformsTo="//@nodes.6"
         In="//@nodes.44"
         associatedWith="//@nodes.17"/>

  <!-- L3 Trace Model for network -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PIM2Network" conformsTo="//@nodes.4">
    <contains name="DesignNetworkTopology">
      <intents name="TopologyDesign">
        <params name="topology_type = star"/>
        <params name="gateway_node = central_controller"/>
        <params name="max_nodes = 50"/>
      </intents>
      <traceLinks name="SensorNodes -> WiFiNetwork"/>
      <traceLinks name="CentralController -> GatewayNode"/>
    </contains>
    <contains name="AssignIPAddresses">
      <intents name="NetworkAddressing">
        <params name="subnet = 192.168.10.0/24"/>
        <params name="dhcp_range = 192.168.10.100-200"/>
      </intents>
      <traceLinks name="TempSensor_Zone1 -> IP_192.168.10.101"/>
      <traceLinks name="PIRSensor_Zone1 -> IP_192.168.10.102"/>
      <traceLinks name="LightController_Zone1 -> IP_192.168.10.103"/>
    </contains>
  </nodes>

  <!-- L3 Trace Model for system architecture decomposition -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_SysArch2SensorNet" conformsTo="//@nodes.4">
    <contains name="DecomposeToSensorNodes">
      <intents name="HardwareDecomposition">
        <params name="sensor_type = DHT22"/>
        <params name="communication = I2C"/>
      </intents>
      <traceLinks name="TempSensor -> DHT22_Sensor"/>
      <traceLinks name="OccupancyDetector -> PIR_AM312"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 4: Platform-Specific to Code Generation ========== -->

  <!-- L4 Transformation -->
  <nodes xmi:type="mpm_trace:Transformation" name="PSM2CodeGeneration"
         exec="//@nodes.46"
         Out="//@nodes.47 //@nodes.48"
         conformsTo="//@nodes.3"/>

  <!-- Additional L4 Transformation for network -->
  <nodes xmi:type="mpm_trace:Transformation" name="Network2Configuration"
         exec="//@nodes.49"
         Out="//@nodes.50"
         conformsTo="//@nodes.3"/>

  <!-- L4 Execution -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_PSM2Code"
         generates="//@nodes.51"/>

  <!-- L4 Output: ESP32 Code -->
  <nodes xmi:type="mpm_trace:Model" name="ESP32_FirmwareCode"
         conformsTo="//@nodes.10"
         In="//@nodes.52"
         associatedWith="//@nodes.19"/>

  <!-- L4 Output: Arduino Code -->
  <nodes xmi:type="mpm_trace:Model" name="Arduino_SensorCode"
         conformsTo="//@nodes.10"
         In="//@nodes.55"
         associatedWith="//@nodes.19"/>

  <!-- L4 Execution for network -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Network2Config"
         generates="//@nodes.53"/>

  <!-- L4 Output: Network Configuration Files -->
  <nodes xmi:type="mpm_trace:Model" name="NetworkConfigFiles"
         conformsTo="//@nodes.10"
         In="//@nodes.56"
         associatedWith="//@nodes.17"/>

  <!-- L4 Trace Model -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_PSM2Code" conformsTo="//@nodes.4">
    <contains name="GeneratePIDControlCode">
      <intents name="CodeGeneration">
        <params name="language = C++"/>
        <params name="framework = ESP-IDF"/>
        <params name="optimization_level = O2"/>
      </intents>
      <traceLinks name="ESP32_PID_Task -> pid_control_task()"/>
      <traceLinks name="ADC_Channel_0 -> adc1_get_raw(ADC1_CHANNEL_0)"/>
      <traceLinks name="GPIO_PWM_Pin -> ledc_set_duty()"/>
    </contains>
    <contains name="GenerateMQTTClientCode">
      <intents name="CommunicationCodeGen">
        <params name="mqtt_library = PubSubClient"/>
        <params name="reconnect_strategy = exponential_backoff"/>
        <params name="max_retries = 5"/>
      </intents>
      <traceLinks name="MQTT_Publisher -> publishOccupancy()"/>
      <traceLinks name="MQTT_Subscriber -> subscribeToLighting()"/>
      <traceLinks name="WiFi_Connection -> setupWiFi()"/>
    </contains>
    <contains name="GenerateTaskScheduler">
      <intents name="RTOSCodeGeneration">
        <params name="scheduler = FreeRTOS"/>
        <params name="pid_task_priority = 5"/>
        <params name="mqtt_task_priority = 3"/>
      </intents>
      <traceLinks name="PIDController -> xTaskCreate(pid_task)"/>
      <traceLinks name="OccupancyPublisher -> xTaskCreate(mqtt_pub_task)"/>
    </contains>
  </nodes>

  <!-- ========== LEVEL 5: Code to Deployment ========== -->

  <!-- L5 Transformation -->
  <nodes xmi:type="mpm_trace:Transformation" name="Code2DeploymentPackage"
         exec="//@nodes.54"
         Out="//@nodes.57"
         conformsTo="//@nodes.3"/>

  <!-- L5 Execution -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Code2Deploy"
         generates="//@nodes.58"/>

  <!-- Additional L5 Transformation for Arduino -->
  <nodes xmi:type="mpm_trace:Transformation" name="ArduinoCode2Deployment"
         exec="//@nodes.59"
         Out="//@nodes.60"
         conformsTo="//@nodes.3"/>

  <!-- Additional L5 Transformation for network -->
  <nodes xmi:type="mpm_trace:Transformation" name="NetworkConfig2Deployment"
         exec="//@nodes.61"
         Out="//@nodes.62"
         conformsTo="//@nodes.3"/>

  <!-- L5 Output: Deployment Package -->
  <nodes xmi:type="mpm_trace:Model" name="ESP32_DeploymentPackage"
         conformsTo="//@nodes.10"
         associatedWith="//@nodes.19"/>

  <!-- L5 Trace Model -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Code2Deploy" conformsTo="//@nodes.4">
    <contains name="CompileForESP32">
      <intents name="CompilationConfig">
        <params name="target = xtensa-esp32"/>
        <params name="flash_size = 4MB"/>
        <params name="partition_scheme = default"/>
      </intents>
      <traceLinks name="ESP32_FirmwareCode -> firmware.bin"/>
      <traceLinks name="PID_Config -> nvs_partition"/>
    </contains>
    <contains name="GenerateOTAPackage">
      <intents name="OTAPreparation">
        <params name="ota_enabled = true"/>
        <params name="version = 1.2.3"/>
        <params name="signature = SHA256"/>
      </intents>
      <traceLinks name="firmware.bin -> firmware_ota.bin"/>
      <traceLinks name="NetworkConfig -> ota_config.json"/>
    </contains>
    <contains name="CreateFlashScript">
      <intents name="DeploymentAutomation">
        <params name="tool = esptool.py"/>
        <params name="baud_rate = 921600"/>
        <params name="flash_mode = dio"/>
      </intents>
      <traceLinks name="firmware.bin -> flash_command.sh"/>
      <traceLinks name="bootloader.bin -> flash_bootloader.sh"/>
    </contains>
  </nodes>

  <!-- L5 Execution for Arduino -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_Arduino2Deploy"
         generates="//@nodes.63"/>

  <!-- L5 Output: Arduino Deployment -->
  <nodes xmi:type="mpm_trace:Model" name="Arduino_DeploymentPackage"
         conformsTo="//@nodes.10"
         associatedWith="//@nodes.19"/>

  <!-- L5 Execution for network -->
  <nodes xmi:type="mpm_trace:TransformationExecution" name="Exec_NetworkConfig2Deploy"
         generates="//@nodes.64"/>

  <!-- L5 Output: Network Deployment -->
  <nodes xmi:type="mpm_trace:Model" name="NetworkDeploymentPackage"
         conformsTo="//@nodes.10"
         associatedWith="//@nodes.17"/>

  <!-- L5 Trace Model for Arduino -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_Arduino2Deploy" conformsTo="//@nodes.4">
    <contains name="CompileArduinoSketch">
      <intents name="ArduinoCompilation">
        <params name="board = Arduino Uno"/>
        <params name="programmer = USBtinyISP"/>
      </intents>
      <traceLinks name="Arduino_SensorCode -> sensor_sketch.hex"/>
    </contains>
  </nodes>

  <!-- L5 Trace Model for network -->
  <nodes xmi:type="mpm_trace:TraceModel" name="Trace_NetworkConfig2Deploy" conformsTo="//@nodes.4">
    <contains name="GenerateRouterConfig">
      <intents name="RouterConfiguration">
        <params name="router_model = Cisco_ISR4000"/>
        <params name="vlan_id = 10"/>
      </intents>
      <traceLinks name="NetworkConfigFiles -> router_config.txt"/>
      <traceLinks name="SubnetConfig -> vlan_10.conf"/>
    </contains>
    <contains name="GenerateMQTTBrokerConfig">
      <intents name="BrokerSetup">
        <params name="broker = Mosquitto_2.0"/>
        <params name="max_connections = 100"/>
        <params name="persistence = true"/>
      </intents>
      <traceLinks name="MQTTConfig -> mosquitto.conf"/>
      <traceLinks name="SecuritySettings -> acl.conf"/>
    </contains>
  </nodes>

</mpm_trace:Canvas>
